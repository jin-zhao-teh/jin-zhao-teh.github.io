<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fusion Reactor Simulation</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary: #1a2b3c;
            --secondary: #2e86de;
            --accent: #ff6b6b;
            --background: #0d1b2a;
            --card-bg: #1e2a3a;
            --text: #e0e1dd;
            --border: #415a77;
            --tokamak: #ff9f43;
            --stellarator: #6ab04c;
            --icf: #f368e0;
            --zpinch: #48dbfb;
            --success: #1dd1a1;
            --warning: #feca57;
            --danger: #ff6b6b;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--background) 0%, #0f2a3f 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #122b3e 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(46, 134, 222, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }
        
        h1 {
            margin: 0;
            font-size: 2.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.85;
            max-width: 900px;
            margin: 15px auto 0;
            position: relative;
            z-index: 2;
            line-height: 1.7;
        }
        
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            position: relative;
            z-index: 5;
        }
        
        .tab-btn {
            flex: 1;
            padding: 18px 20px;
            background: none;
            border: none;
            font-size: 1.15rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text);
            transition: all 0.4s ease;
            border-bottom: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: rgba(46, 134, 222, 0.2);
            transition: height 0.4s ease;
            z-index: -1;
        }
        
        .tab-btn.active {
            color: var(--secondary);
            border-bottom: 3px solid var(--secondary);
        }
        
        .tab-btn.active::before {
            height: 100%;
        }
        
        .tab-btn:hover:not(.active)::before {
            height: 30%;
        }
        
        .tab-content {
            display: none;
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            margin-bottom: 35px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }
        
        .tab-content::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top right, rgba(46, 134, 222, 0.1) 0%, transparent 70%);
            pointer-events: none;
            border-radius: 15px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-section {
            margin-bottom: 40px;
        }
        
        .tab-section:last-child {
            margin-bottom: 0;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--secondary);
            position: relative;
            padding-bottom: 10px;
        }
        
        h2::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 3px;
            background: var(--secondary);
            border-radius: 2px;
        }
        
        p {
            margin-bottom: 20px;
            line-height: 1.7;
            color: rgba(255,255,255,0.8);
        }
        
        .plot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .plot-container {
            height: 450px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 10, 30, 0.4);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 20, 40, 0.3);
            border-radius: 12px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(46, 134, 222, 0.15);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            min-width: 300px;
        }
        
        .control-group label {
            font-weight: 600;
            color: var(--secondary);
            min-width: 180px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(46, 134, 222, 0.5);
        }
        
        .value-display {
            min-width: 100px;
            text-align: right;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .device-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: rgba(0, 15, 35, 0.4);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .device-table th {
            background: var(--primary);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
        }
        
        .device-table td {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
        }
        
        .device-table tr:last-child td {
            border-bottom: none;
        }
        
        .device-table tr:hover {
            background: rgba(46, 134, 222, 0.1);
        }
        
        .color-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 8px currentColor;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-stable {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .status-warning {
            background: var(--warning);
            box-shadow: 0 0 8px var(--warning);
        }
        
        .status-critical {
            background: var(--danger);
            box-shadow: 0 0 8px var(--danger);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .btn {
            background: linear-gradient(135deg, var(--secondary) 0%, #1a73e8 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
            box-shadow: 0 4px 15px rgba(46, 134, 222, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 134, 222, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.btn-danger {
            background: linear-gradient(135deg, var(--accent) 0%, #e84118 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .btn.btn-danger:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .simulation-controls {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .info-panel {
            background: rgba(10, 40, 70, 0.3);
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 4px solid var(--secondary);
        }
        
        .physics-formulas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .formula-card {
            background: rgba(0, 20, 40, 0.3);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
        }
        
        .formula-card:hover {
            transform: translateY(-5px);
        }
        
        .formula-card h3 {
            margin-top: 0;
            color: var(--secondary);
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 10, 30, 0.5);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.15rem;
            overflow-x: auto;
            border-left: 3px solid var(--secondary);
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        
        .device-card {
            background: rgba(0, 20, 40, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            border-top: 4px solid var(--secondary);
            position: relative;
            overflow: hidden;
        }
        
        .device-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at bottom right, rgba(46, 134, 222, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .device-card h3 {
            margin-top: 0;
            color: var(--secondary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .device-card h3 .device-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: rgba(46, 134, 222, 0.2);
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .param-row:last-child {
            border-bottom: none;
        }
        
        .param-label {
            font-weight: 600;
            color: rgba(255,255,255,0.85);
        }
        
        .param-value {
            font-weight: 500;
            color: var(--secondary);
        }
        
        .power-control {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .visualization-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 5, 15, 0.5);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin: 30px 0;
            position: relative;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        #reactor3d {
            width: 100%;
            height: 100%;
        }
        
        .device-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .device-btn {
            padding: 12px 24px;
            background: rgba(46, 134, 222, 0.15);
            border: none;
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .device-btn.active {
            background: var(--secondary);
            color: white;
        }
        
        .device-btn:hover:not(.active) {
            background: rgba(46, 134, 222, 0.25);
        }
        
        @media (max-width: 1200px) {
            .plot-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
            }
            
            .simulation-controls {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Advanced Fusion Reactor Simulation</h1>
            <p class="subtitle">Scientifically accurate simulation of fusion reactor performance with real-time plasma physics modeling, stability analysis, and device-specific confinement physics</p>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn" data-tab="physics">Physics Models</button>
            <button class="tab-btn" data-tab="devices">Device Parameters</button>
            <button class="tab-btn" data-tab="visualization">3D Visualization</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="tab-section">
                <h2>Reactor Control Panel</h2>
                <p>Adjust power input and monitor stability parameters for each reactor type. Set power to zero to shutdown reactors.</p>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="tokamakPower">Tokamak Power (MW)</label>
                        <input type="range" id="tokamakPower" min="0" max="100" value="50">
                        <span id="tokamakPowerValue" class="value-display">50 MW</span>
                    </div>
                    
                    <div class="control-group">
                        <label for="iterPower">ITER Power (MW)</label>
                        <input type="range" id="iterPower" min="0" max="120" value="70">
                        <span id="iterPowerValue" class="value-display">70 MW</span>
                    </div>
                    
                    <div class="control-group">
                        <label for="icfPower">ICF Laser Power (TW)</label>
                        <input type="range" id="icfPower" min="0" max="500" value="300">
                        <span id="icfPowerValue" class="value-display">300 TW</span>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="zpinchPower">Z-Pinch Power (GW)</label>
                        <input type="range" id="zpinchPower" min="0" max="50" value="25">
                        <span id="zpinchPowerValue" class="value-display">25 GW</span>
                    </div>
                    
                    <div class="control-group">
                        <label for="stellaratorPower">Stellarator Power (MW)</label>
                        <input type="range" id="stellaratorPower" min="0" max="80" value="40">
                        <span id="stellaratorPowerValue" class="value-display">40 MW</span>
                    </div>
                </div>
                
                <div class="simulation-controls">
                    <button id="startBtn" class="btn">
                        <i class="fas fa-play"></i> Start Simulation
                    </button>
                    <button id="pauseBtn" class="btn">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    <button id="resetBtn" class="btn btn-danger">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </div>
            
            <div class="tab-section">
                <h2>Fusion Power Output</h2>
                <p>Comparison of fusion power generation across different reactor designs. Power scales vary based on confinement type.</p>
                
                <div class="plot-container" id="fusionPowerPlot"></div>
            </div>
            
            <div class="tab-section">
                <h2>Reactor Status & Diagnostics</h2>
                
                <table class="device-table">
                    <thead>
                        <tr>
                            <th>Device</th>
                            <th>Power (MW)</th>
                            <th>Q Factor</th>
                            <th>Plasma β</th>
                            <th>Density Limit</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="plot-grid">
                <div class="plot-container" id="tempEvolutionPlot"></div>
                <div class="plot-container" id="densityEvolutionPlot"></div>
            </div>
        </div>
        
        <!-- Physics Models Tab -->
        <div id="physics" class="tab-content">
            <h2>Fusion Physics Models</h2>
            <p>Advanced physics models used in the simulation with device-specific implementations for magnetic and inertial confinement.</p>
            
            <div class="info-panel">
                <p>This simulation uses scientifically accurate models for fusion reactor physics:</p>
                <ul>
                    <li><strong>Magnetic Confinement (Tokamak/Stellarator):</strong> Gyrokinetic turbulence, neoclassical transport, alpha particle heating</li>
                    <li><strong>Inertial Confinement (ICF):</strong> Laser-plasma interaction, Rayleigh-Taylor instability, hot-spot ignition</li>
                    <li><strong>Radiation:</strong> Bremsstrahlung, synchrotron, and line radiation with impurity transport</li>
                    <li><strong>Stability:</strong> Troyon limit (β<sub>N</sub>), Greenwald density limit, kink and ballooning modes</li>
                </ul>
            </div>
            
            <div class="physics-formulas">
                <div class="formula-card">
                    <h3>Fusion Power Density</h3>
                    <p>For DT magnetic confinement:</p>
                    <div class="formula">P<sub>fusion</sub> = (1/4) n² ⟨σv⟩ E<sub>fusion</sub></div>
                    
                    <p>For ICF hot-spot ignition:</p>
                    <div class="formula">P<sub>icf</sub> = ρR ⋅ (ρR)<sub>ignition</sub> ⋅ exp(-(T - T<sub>ign</sub>)²/2σ²)</div>
                    
                    <p>Where ⟨σv⟩ is the reactivity, E<sub>fusion</sub> = 17.6 MeV</p>
                </div>
                
                <div class="formula-card">
                    <h3>Plasma Transport</h3>
                    <p>Gyro-Bohm diffusion:</p>
                    <div class="formula">χ = α (T<sub>e</sub><sup>3/2</sup> / B<sup>2</sup>)</div>
                    
                    <p>Neoclassical transport:</p>
                    <div class="formula">χ<sub>neo</sub> = q² ρ<sub>i</sub><sup>2</sup> ν<sub>ii</sub></div>
                    
                    <p>Energy confinement scaling (ITER-98y):</p>
                    <div class="formula">τ<sub>E</sub> = 0.0562 I<sub>p</sub><sup>0.93</sup> B<sub>t</sub><sup>0.15</sup> n̄<sup>0.41</sup> P<sup>-0.69</sup> R<sup>1.97</sup></div>
                </div>
                
                <div class="formula-card">
                    <h3>Stability Limits</h3>
                    <p>Troyon beta limit:</p>
                    <div class="formula">β<sub>max</sub> = β<sub>N</sub> (I<sub>p</sub> / aB) [%]</div>
                    
                    <p>Greenwald density limit:</p>
                    <div class="formula">n<sub>G</sub> = I<sub>p</sub> / πa² [10²⁰ m⁻³]</div>
                    
                    <p>Kink stability:</p>
                    <div class="formula">q(a) > 2, q(0) > 1</div>
                </div>
            </div>
            
            <div class="plot-grid">
                <div class="plot-container" id="stabilityPlot"></div>
                <div class="plot-container" id="confinementPlot"></div>
            </div>
        </div>
        
        <!-- Device Parameters Tab -->
        <div id="devices" class="tab-content">
            <h2>Device Configuration</h2>
            <p>Parameters for each fusion reactor type. Adjustments affect performance and stability.</p>
            
            <div class="device-grid" id="deviceCards">
                <!-- Filled by JavaScript -->
            </div>
        </div>
        
        <!-- Visualization Tab -->
        <div id="visualization" class="tab-content">
            <h2>3D Reactor Visualization</h2>
            <p>Interactive visualization of tokamak magnetic field lines and ICF pellet compression.</p>
            
            <div class="device-selector">
                <button class="device-btn active" data-device="tokamak">Tokamak</button>
                <button class="device-btn" data-device="icf">Inertial Confinement</button>
                <button class="device-btn" data-device="stellarator">Stellarator</button>
                <button class="device-btn" data-device="zpinch">Z-Pinch</button>
            </div>
            
            <div class="visualization-container">
                <div id="reactor3d"></div>
            </div>
            
            <div class="info-panel">
                <h3>Visualization Controls</h3>
                <p><strong>Rotate:</strong> Click and drag | <strong>Zoom:</strong> Scroll wheel | <strong>Pan:</strong> Right-click and drag</p>
                <p>Colors represent magnetic field strength (blue = weak, red = strong) and plasma density.</p>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const keV_to_J = 1.602e-16;
        const e = 1.602e-19;
        const m_proton = 1.67e-27;
        const c = 3e8;
        
        // Device parameters with more realistic values
        const devices = {
            "Tokamak": {
                "n0": 1e20, "T0": 12, "V": 200, "fuel": "DT", 
                "I_p": 15e6, "B0": 5.5, "R": 6.2, "a": 2.0,
                "q95": 3.0, "H98": 1.2, "Z_eff": 1.8, "beta_N": 2.0,
                "power": 50, "color": "#ff9f43",
                "type": "magnetic", "status": "stable"
            },
            "ITER": {
                "n0": 1.2e20, "T0": 25, "V": 840, "fuel": "DT", 
                "I_p": 15e6, "B0": 5.3, "R": 6.2, "a": 2.0,
                "q95": 3.1, "H98": 1.0, "Z_eff": 1.5, "beta_N": 1.8,
                "power": 70, "color": "#ff7f0e",
                "type": "magnetic", "status": "stable"
            },
            "ICF": {
                "n0": 1e31, "T0": 4, "V": 1e-9, "fuel": "DT", 
                "laser_energy": 2.0, "target_mass": 0.0002, "implosion_velocity": 3e5,
                "asymmetry": 0.1, "hot_spot_ratio": 0.3, "convergence": 30,
                "power": 300, "color": "#f368e0",
                "type": "inertial", "status": "stable"
            },
            "Z-Pinch": {
                "n0": 5e22, "T0": 2, "V": 0.02, "fuel": "DT", 
                "I_p": 60e6, "B0": 1000, "R": 0.02, "a": 0.005,
                "implosion_time": 100e-9, "stability_factor": 0.7, "Z_eff": 2.5,
                "power": 25, "color": "#48dbfb",
                "type": "magnetic", "status": "warning"
            },
            "Stellarator": {
                "n0": 3e19, "T0": 6, "V": 30, "fuel": "DT", 
                "B0": 3.0, "R": 5.5, "a": 0.6, "rotational_transform": 0.3,
                "neoclassical_transport": 0.15, "turbulent_transport": 0.4, "Z_eff": 1.6,
                "power": 40, "color": "#6ab04c",
                "type": "magnetic", "status": "stable"
            }
        };
        
        // Simulation state
        let simulationTime = 0;
        let simulationRunning = false;
        let simulationInterval;
        let threeScene, threeCamera, threeRenderer, threeControls;
        let currentDevice = "tokamak";
        
        // Initialize simulations
        function initSimulations() {
            // Initialize simulation data arrays
            Object.keys(devices).forEach(dev => {
                devices[dev].timeData = [0];
                devices[dev].powerData = [0];
                devices[dev].tempData = [devices[dev].T0];
                devices[dev].densityData = [devices[dev].n0];
                devices[dev].qData = [1];
                devices[dev].betaData = [0.01];
                devices[dev].status = "stable";
            });
        }
        
        // Physics functions
        function sigma_v(T, fuel) {
            T = Math.max(T, 0.1); // Avoid negative temperatures
            
            if (fuel === "DT") {
                // More accurate DT reactivity
                const T_keV = T;
                const C1 = 5.657e-16;
                const C2 = 1.472e-2;
                const C3 = 6.535e-3;
                const C4 = 1.445e-1;
                const C5 = 9.922e-1;
                const theta = T_keV / (1 - (T_keV*(C2 + T_keV*(C4 + T_keV*C5))/(1 + T_keV*(C3 + T_keV*C5)));
                return C1 * Math.pow(theta, 5/6) * Math.exp(-3.77 * Math.pow(theta, 1/3)) / Math.pow(T_keV, 2/3);
            } 
            else if (fuel === "DHe3") {
                return 2.5e-21 * Math.pow(T, -2/3) * Math.exp(-18.8 * Math.pow(T, -1/3));
            } 
            else { // DD
                return 1.6e-22 * Math.pow(T, -2/3) * Math.exp(-18.76 * Math.pow(T, -1/3));
            }
        }
        
        function fusion_energy(fuel) {
            if (fuel === "DT") return 17.6e6 * e;
            if (fuel === "DHe3") return 18.3e6 * e;
            return 3.65e6 * e; // DD
        }
        
        function P_brem(n, T, Z_eff) {
            return 1.69e-38 * Z_eff * n * n * Math.sqrt(T);
        }
        
        function P_synch(n, T, B) {
            return 6.21e-22 * n * n * Math.pow(T, 2) * Math.pow(B, 2);
        }
        
        // Calculate Q factor (fusion power / input power)
        function calculateQ(device) {
            const params = devices[device];
            const inputPower = params.power * 1e6; // Convert MW to W
            
            if (inputPower < 1e3) return 0; // Avoid division by zero
            
            if (params.type === "inertial") {
                // ICF specific calculation
                const hotSpotEnergy = 0.5 * params.target_mass * Math.pow(params.implosion_velocity, 2);
                const fusionEnergy = params.powerData[params.powerData.length - 1] * 0.1; // 100ms pulse
                return fusionEnergy / (inputPower * 1e-3); // Input in TW, pulse in ns
            }
            
            // Magnetic confinement
            return params.powerData[params.powerData.length - 1] / inputPower;
        }
        
        // Calculate plasma beta (β = 2μ₀<p>/B²)
        function calculateBeta(device) {
            const params = devices[device];
            const n = params.densityData[params.densityData.length - 1];
            const T = params.tempData[params.tempData.length - 1] * 1e3 * e; // Convert keV to J
            
            if (params.type === "inertial") {
                // For ICF, beta is not meaningful
                return 0;
            }
            
            const pressure = 2.4 * n * T; // Total pressure (ions + electrons)
            return (2 * 4 * Math.PI * 1e-7 * pressure) / Math.pow(params.B0, 2);
        }
        
        // Calculate Greenwald density limit
        function greenwaldLimit(device) {
            const params = devices[device];
            return params.I_p * 1e-6 / (Math.PI * Math.pow(params.a, 2)); // in 10²⁰ m⁻³
        }
        
        // Update device status based on physics
        function updateDeviceStatus(device) {
            const params = devices[device];
            const beta = calculateBeta(device);
            const q = params.q95;
            const n_greenwald = greenwaldLimit(device);
            const n_current = params.densityData[params.densityData.length - 1] / 1e20;
            
            if (params.type === "magnetic") {
                // Check stability limits
                if (beta > (params.beta_N * params.I_p * 1e-6 / (params.a * params.B0))) {
                    params.status = "critical";
                } 
                else if (n_current > 0.85 * n_greenwald) {
                    params.status = "warning";
                } 
                else if (q < 2.0) {
                    params.status = "warning";
                } 
                else {
                    params.status = "stable";
                }
            } 
            else { // ICF
                // Check for ignition conditions
                const areal_density = params.target_mass * params.convergence;
                if (params.tempData[params.tempData.length - 1] < 10) {
                    params.status = "warning";
                } 
                else if (areal_density < 0.3) {
                    params.status = "critical";
                } 
                else {
                    params.status = "stable";
                }
            }
        }
        
        // Step simulation for each device
        function stepSimulation() {
            simulationTime += 0.1;
            
            Object.keys(devices).forEach(dev => {
                const params = devices[dev];
                const prevPower = params.powerData[params.powerData.length - 1] || 0;
                const prevTemp = params.tempData[params.tempData.length - 1] || params.T0;
                const prevDensity = params.densityData[params.densityData.length - 1] || params.n0;
                
                if (params.type === "magnetic") {
                    // Magnetic confinement physics
                    const inputPower = params.power * 1e6; // Convert MW to W
                    const confinementTime = 0.0562 * 
                        Math.pow(params.I_p * 1e-6, 0.93) *
                        Math.pow(params.B0, 0.15) *
                        Math.pow(prevDensity / 1e20, 0.41) *
                        Math.pow(inputPower / 1e6, -0.69) *
                        Math.pow(params.R, 1.97);
                        
                    const sv = sigma_v(prevTemp, params.fuel);
                    const E_fus = fusion_energy(params.fuel);
                    const fusionPower = 0.25 * prevDensity * prevDensity * sv * E_fus * params.V;
                    
                    // Temperature change (dT/dt = (P_heat - P_loss) / (3nV)
                    const P_heat = inputPower + (0.2 * fusionPower); // Auxiliary + alpha heating
                    const P_loss = P_brem(prevDensity, prevTemp, params.Z_eff) * params.V + 
                                  P_synch(prevDensity, prevTemp, params.B0) * params.V;
                    
                    const dT_dt = (P_heat - P_loss) / (3 * prevDensity * params.V * keV_to_J);
                    const newTemp = Math.max(0.1, prevTemp + dT_dt * 0.1);
                    
                    // Density evolution
                    const fuelingRate = 5e19 * params.power / 50; // Scale with power
                    const densityDecay = prevDensity / confinementTime;
                    const newDensity = Math.max(1e18, prevDensity + (fuelingRate - densityDecay) * 0.1);
                    
                    // Update device data
                    params.powerData.push(fusionPower);
                    params.tempData.push(newTemp);
                    params.densityData.push(newDensity);
                } 
                else { // Inertial Confinement Fusion
                    const inputPower = params.power * 1e12; // Convert TW to W
                    const pulseDuration = 1e-9; // 1 ns pulse
                    const laserEnergy = inputPower * pulseDuration;
                    
                    // Simplified ICF model
                    const implosionEfficiency = 0.1 * (1 - params.asymmetry);
                    const hotSpotEnergy = laserEnergy * implosionEfficiency;
                    
                    // Hot-spot temperature (E = 3/2 nT V)
                    const hotSpotVolume = params.V * params.hot_spot_ratio;
                    const hotSpotDensity = 5e31; // High density in hot spot
                    const hotSpotTemp = (2 * hotSpotEnergy) / (3 * hotSpotDensity * hotSpotVolume * keV_to_J);
                    
                    // Fusion reactions in hot spot
                    const sv = sigma_v(hotSpotTemp, params.fuel);
                    const E_fus = fusion_energy(params.fuel);
                    const fusionPower = 0.25 * hotSpotDensity * hotSpotDensity * sv * E_fus * hotSpotVolume;
                    
                    // For display, we'll simulate a decaying pulse
                    const decayFactor = Math.exp(-simulationTime / 0.2);
                    const displayPower = fusionPower * decayFactor;
                    
                    // Update device data
                    params.powerData.push(displayPower);
                    params.tempData.push(hotSpotTemp);
                    params.densityData.push(hotSpotDensity);
                }
                
                params.timeData.push(simulationTime);
                updateDeviceStatus(dev);
            });
            
            updatePlots();
            updateDeviceTable();
            updateDeviceCards();
        }
        
        // Initialize 3D visualization
        function init3DVisualization() {
            const container = document.getElementById('reactor3d');
            
            // Scene setup
            threeScene = new THREE.Scene();
            threeScene.background = new THREE.Color(0x0d1b2a);
            
            // Camera setup
            threeCamera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            threeCamera.position.z = 15;
            
            // Renderer setup
            threeRenderer = new THREE.WebGLRenderer({ antialias: true });
            threeRenderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(threeRenderer.domElement);
            
            // Controls
            threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
            threeControls.enableDamping = true;
            threeControls.dampingFactor = 0.05;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            threeScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7);
            threeScene.add(directionalLight);
            
            // Create initial tokamak visualization
            createTokamakVisualization();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                threeCamera.aspect = container.clientWidth / container.clientHeight;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(container.clientWidth, container.clientHeight);
            });
            
            // Start animation loop
            animate();
        }
        
        // Create tokamak visualization
        function createTokamakVisualization() {
            // Clear existing objects
            while(threeScene.children.length > 2) { 
                threeScene.remove(threeScene.children[2]); 
            }
            
            const R = 5;  // Major radius
            const r = 1.5; // Minor radius
            
            // Torus geometry for plasma
            const torusGeometry = new THREE.TorusGeometry(R, r, 32, 64);
            const torusMaterial = new THREE.MeshPhongMaterial({
                color: 0xff9f43,
                emissive: 0x883300,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            const plasma = new THREE.Mesh(torusGeometry, torusMaterial);
            threeScene.add(plasma);
            
            // Magnetic field lines
            const fieldLines = new THREE.Group();
            
            for (let i = 0; i < 12; i++) {
                const phi = (i / 12) * Math.PI * 2;
                
                const points = [];
                for (let theta = 0; theta <= Math.PI * 2; theta += 0.1) {
                    // Toroidal coordinates
                    const x = (R + r * Math.cos(theta)) * Math.cos(phi);
                    const y = r * Math.sin(theta);
                    const z = (R + r * Math.cos(theta)) * Math.sin(phi);
                    points.push(new THREE.Vector3(x, y, z));
                }
                
                const lineGeometry = new THREE.BufferGeometry().setFromPoints(points);
                const lineMaterial = new THREE.LineBasicMaterial({ 
                    color: 0x2e86de,
                    transparent: true,
                    opacity: 0.6
                });
                const line = new THREE.Line(lineGeometry, lineMaterial);
                fieldLines.add(line);
            }
            
            threeScene.add(fieldLines);
            
            // Coils
            const coilGroup = new THREE.Group();
            const coilGeometry = new THREE.TorusGeometry(0.3, 0.1, 16, 32);
            const coilMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const coil = new THREE.Mesh(coiGeometry, coilMaterial);
                coil.position.set(R * Math.cos(angle), 0, R * Math.sin(angle));
                coil.rotation.x = Math.PI / 2;
                coilGroup.add(coil);
            }
            
            threeScene.add(coilGroup);
        }
        
        // Create ICF visualization
        function createICFVisualization() {
            // Clear existing objects
            while(threeScene.children.length > 2) { 
                threeScene.remove(threeScene.children[2]); 
            }
            
            // Create target chamber
            const chamberGeometry = new THREE.SphereGeometry(4, 32, 32);
            const chamberMaterial = new THREE.MeshPhongMaterial({
                color: 0x444444,
                wireframe: true,
                transparent: true,
                opacity: 0.3
            });
            const chamber = new THREE.Mesh(chamberGeometry, chamberMaterial);
            threeScene.add(chamber);
            
            // Create target pellet
            const pelletGeometry = new THREE.SphereGeometry(1, 32, 32);
            const pelletMaterial = new THREE.MeshPhongMaterial({
                color: 0xf368e0,
                emissive: 0x551033,
                transparent: true,
                opacity: 0.9
            });
            const pellet = new THREE.Mesh(pelletGeometry, pelletMaterial);
            threeScene.add(pellet);
            
            // Create laser beams
            const beamGroup = new THREE.Group();
            const beamMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ffff,
                transparent: true,
                opacity: 0.7,
                side: THREE.DoubleSide
            });
            
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                const height = 7;
                
                const beamGeometry = new THREE.CylinderGeometry(0.1, 0.3, height, 8);
                const beam = new THREE.Mesh(beamGeometry, beamMaterial);
                
                beam.rotation.z = angle;
                beam.rotation.x = Math.PI / 2;
                beam.position.set(
                    height/2 * Math.cos(angle),
                    height/2 * Math.sin(angle),
                    0
                );
                
                beamGroup.add(beam);
            }
            
            threeScene.add(beamGroup);
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            threeControls.update();
            threeRenderer.render(threeScene, threeCamera);
        }
        
        // Initialize plots
        function initPlots() {
            // Fusion power plot
            const fusionPowerData = Object.keys(devices).map(dev => {
                return {
                    x: devices[dev].timeData,
                    y: devices[dev].powerData,
                    name: dev,
                    mode: 'lines',
                    line: {color: devices[dev].color, width: 3}
                };
            });
            
            Plotly.newPlot('fusionPowerPlot', fusionPowerData, {
                title: 'Fusion Power Output',
                xaxis: {title: 'Time (s)', gridcolor: 'rgba(255,255,255,0.1)'},
                yaxis: {title: 'Power (W)', type: 'log', gridcolor: 'rgba(255,255,255,0.1)'},
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e1dd'},
                showlegend: true,
                legend: {x: 1.05, y: 1}
            });
            
            // Temperature evolution plot
            const tempEvolutionData = Object.keys(devices).map(dev => {
                return {
                    x: devices[dev].timeData,
                    y: devices[dev].tempData,
                    name: dev,
                    mode: 'lines',
                    line: {color: devices[dev].color, width: 2}
                };
            });
            
            Plotly.newPlot('tempEvolutionPlot', tempEvolutionData, {
                title: 'Plasma Temperature Evolution',
                xaxis: {title: 'Time (s)', gridcolor: 'rgba(255,255,255,0.1)'},
                yaxis: {title: 'Temperature (keV)', gridcolor: 'rgba(255,255,255,0.1)'},
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e1dd'},
                showlegend: true
            });
            
            // Density evolution plot
            const densityEvolutionData = Object.keys(devices).map(dev => {
                return {
                    x: devices[dev].timeData,
                    y: devices[dev].densityData,
                    name: dev,
                    mode: 'lines',
                    line: {color: devices[dev].color, width: 2}
                };
            });
            
            Plotly.newPlot('densityEvolutionPlot', densityEvolutionData, {
                title: 'Plasma Density Evolution',
                xaxis: {title: 'Time (s)', gridcolor: 'rgba(255,255,255,0.1)'},
                yaxis: {title: 'Density (m⁻³)', type: 'log', gridcolor: 'rgba(255,255,255,0.1)'},
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e1dd'},
                showlegend: true
            });
            
            // Stability plot
            const stabilityData = Object.keys(devices).filter(dev => devices[dev].type === "magnetic").map(dev => {
                return {
                    x: devices[dev].timeData,
                    y: devices[dev].densityData.map(d => d / 1e20),
                    name: dev + " Density",
                    mode: 'lines',
                    line: {color: devices[dev].color, width: 2}
                };
            });
            
            // Add Greenwald limit
            Object.keys(devices).filter(dev => devices[dev].type === "magnetic").forEach(dev => {
                const limit = greenwaldLimit(dev);
                stabilityData.push({
                    x: [0, 10],
                    y: [limit, limit],
                    name: dev + " Greenwald Limit",
                    mode: 'lines',
                    line: {color: devices[dev].color, width: 2, dash: 'dash'}
                });
            });
            
            Plotly.newPlot('stabilityPlot', stabilityData, {
                title: 'Density vs Greenwald Limit',
                xaxis: {title: 'Time (s)', gridcolor: 'rgba(255,255,255,0.1)'},
                yaxis: {title: 'Density (10²⁰ m⁻³)', gridcolor: 'rgba(255,255,255,0.1)'},
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#e0e1dd'},
                showlegend: true
            });
        }
        
        // Update plots
        function updatePlots() {
            // Fusion power plot
            const fusionUpdate = Object.keys(devices).map(dev => {
                return {
                    x: [devices[dev].timeData],
                    y: [devices[dev].powerData]
                };
            });
            
            Plotly.update('fusionPowerPlot', {
                x: fusionUpdate.map(u => u.x[0]),
                y: fusionUpdate.map(u => u.y[0])
            });
            
            // Temperature plot
            const tempUpdate = Object.keys(devices).map(dev => {
                return {
                    x: [devices[dev].timeData],
                    y: [devices[dev].tempData]
                };
            });
            
            Plotly.update('tempEvolutionPlot', {
                x: tempUpdate.map(u => u.x[0]),
                y: tempUpdate.map(u => u.y[0])
            });
            
            // Density plot
            const densityUpdate = Object.keys(devices).map(dev => {
                return {
                    x: [devices[dev].timeData],
                    y: [devices[dev].densityData]
                };
            });
            
            Plotly.update('densityEvolutionPlot', {
                x: densityUpdate.map(u => u.x[0]),
                y: densityUpdate.map(u => u.y[0])
            });
            
            // Stability plot
            const stabilityUpdate = Object.keys(devices)
                .filter(dev => devices[dev].type === "magnetic")
                .map(dev => {
                    return {
                        x: [devices[dev].timeData],
                        y: [devices[dev].densityData.map(d => d / 1e20)]
                    };
                });
            
            Plotly.update('stabilityPlot', {
                x: stabilityUpdate.map(u => u.x[0]),
                y: stabilityUpdate.map(u => u.y[0])
            }, [0, 1, 2, 3, 4]); // Update indices for magnetic devices
        }
        
        // Update device table
        function updateDeviceTable() {
            const tableBody = document.getElementById('deviceTableBody');
            tableBody.innerHTML = '';
            
            Object.keys(devices).forEach(dev => {
                const params = devices[dev];
                const power = params.powerData[params.powerData.length - 1] || 0;
                const qFactor = calculateQ(dev).toFixed(2);
                const beta = calculateBeta(dev).toFixed(3);
                const greenwald = greenwaldLimit(dev).toFixed(2);
                const density = (params.densityData[params.densityData.length - 1] / 1e20).toFixed(2);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="color-indicator" style="background-color:${params.color}"></span>${dev}</td>
                    <td>${(power / 1e6).toFixed(2)}</td>
                    <td>${qFactor}</td>
                    <td>${beta}</td>
                    <td>${density} / ${greenwald}</td>
                    <td>
                        <span class="status-indicator status-${params.status}"></span>
                        ${params.status.charAt(0).toUpperCase() + params.status.slice(1)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Create device cards
        function createDeviceCards() {
            const container = document.getElementById('deviceCards');
            container.innerHTML = '';
            
            Object.keys(devices).forEach(dev => {
                const params = devices[dev];
                const card = document.createElement('div');
                card.className = 'device-card';
                card.style.borderTopColor = params.color;
                
                let paramsHtml = '';
                Object.keys(params).forEach(key => {
                    if (!['color', 'type', 'status', 'timeData', 'powerData', 'tempData', 'densityData'].includes(key)) {
                        let value = params[key];
                        let unit = '';
                        
                        // Format values with units
                        if (key === 'n0') {
                            value = (value / 1e20).toFixed(2);
                            unit = ' ×10²⁰ m⁻³';
                        } else if (key === 'T0') {
                            unit = ' keV';
                        } else if (key === 'V') {
                            value = value < 1 ? (value * 1e3).toFixed(1) : value.toFixed(1);
                            unit = value < 1 ? ' L' : ' m³';
                        } else if (key === 'I_p' || key === 'B0') {
                            unit = key === 'I_p' ? ' MA' : ' T';
                            value = (value / (key === 'I_p' ? 1e6 : 1)).toFixed(1);
                        } else if (key === 'R' || key === 'a') {
                            unit = ' m';
                            value = value.toFixed(2);
                        } else if (key === 'power') {
                            unit = params.type === "inertial" ? ' TW' : ' MW';
                        } else if (key === 'laser_energy') {
                            unit = ' MJ';
                        } else if (key === 'target_mass') {
                            value = (value * 1e3).toFixed(3);
                            unit = ' g';
                        } else if (key === 'implosion_velocity') {
                            value = (value / 1e5).toFixed(0);
                            unit = ' km/s';
                        }
                        
                        paramsHtml += `
                            <div class="param-row">
                                <span class="param-label">${key.replace(/_/g, ' ')}:</span>
                                <span class="param-value">${value}${unit}</span>
                            </div>
                        `;
                    }
                });
                
                // Add power control
                paramsHtml += `
                    <div class="power-control">
                        <div class="param-row">
                            <span class="param-label">Input Power:</span>
                            <span class="param-value">${params.power} ${params.type === "inertial" ? 'TW' : 'MW'}</span>
                        </div>
                        <input type="range" id="${dev}PowerSlider" min="0" max="${dev === 'ICF' ? 500 : 100}" 
                               value="${params.power}" style="width:100%; margin-top:10px;">
                    </div>
                `;
                
                card.innerHTML = `
                    <h3>
                        <span class="device-icon">${dev[0]}</span>
                        ${dev}
                    </h3>
                    <div>${paramsHtml}</div>
                `;
                container.appendChild(card);
                
                // Add event listener to slider
                document.getElementById(`${dev}PowerSlider`).addEventListener('input', function() {
                    devices[dev].power = parseFloat(this.value);
                    if (dev === 'ICF') {
                        document.getElementById('icfPower').value = this.value;
                        document.getElementById('icfPowerValue').textContent = this.value + ' TW';
                    } else if (dev === 'Tokamak') {
                        document.getElementById('tokamakPower').value = this.value;
                        document.getElementById('tokamakPowerValue').textContent = this.value + ' MW';
                    }
                });
            });
        }
        
        // Update device cards
        function updateDeviceCards() {
            Object.keys(devices).forEach(dev => {
                const slider = document.getElementById(`${dev}PowerSlider`);
                if (slider) {
                    slider.value = devices[dev].power;
                }
            });
        }
        
        // Tab switching
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Device switching in visualization
        function setupDeviceButtons() {
            const deviceBtns = document.querySelectorAll('.device-btn');
            
            deviceBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    deviceBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDevice = btn.getAttribute('data-device');
                    
                    if (currentDevice === 'tokamak') {
                        createTokamakVisualization();
                    } else if (currentDevice === 'icf') {
                        createICFVisualization();
                    }
                });
            });
        }
        
        // Power slider controls
        function setupPowerControls() {
            // Tokamak
            document.getElementById('tokamakPower').addEventListener('input', function() {
                devices['Tokamak'].power = parseFloat(this.value);
                document.getElementById('tokamakPowerValue').textContent = this.value + ' MW';
            });
            
            // ITER
            document.getElementById('iterPower').addEventListener('input', function() {
                devices['ITER'].power = parseFloat(this.value);
                document.getElementById('iterPowerValue').textContent = this.value + ' MW';
            });
            
            // ICF
            document.getElementById('icfPower').addEventListener('input', function() {
                devices['ICF'].power = parseFloat(this.value);
                document.getElementById('icfPowerValue').textContent = this.value + ' TW';
            });
            
            // Z-Pinch
            document.getElementById('zpinchPower').addEventListener('input', function() {
                devices['Z-Pinch'].power = parseFloat(this.value);
                document.getElementById('zpinchPowerValue').textContent = this.value + ' GW';
            });
            
            // Stellarator
            document.getElementById('stellaratorPower').addEventListener('input', function() {
                devices['Stellarator'].power = parseFloat(this.value);
                document.getElementById('stellaratorPowerValue').textContent = this.value + ' MW';
            });
        }
        
        // Simulation controls
        function setupControls() {
            document.getElementById('startBtn').addEventListener('click', () => {
                if (!simulationRunning) {
                    simulationRunning = true;
                    simulationInterval = setInterval(stepSimulation, 200);
                }
            });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                simulationRunning = false;
                clearInterval(simulationInterval);
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                simulationRunning = false;
                clearInterval(simulationInterval);
                simulationTime = 0;
                initSimulations();
                updatePlots();
                updateDeviceTable();
                updateDeviceCards();
            });
        }
        
        // Initialize the application
        function initApp() {
            initSimulations();
            initPlots();
            updateDeviceTable();
            createDeviceCards();
            setupTabs();
            setupPowerControls();
            setupControls();
            setupDeviceButtons();
            init3DVisualization();
        }
        
        // Start the application when the page loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
